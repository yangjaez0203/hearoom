name: Deploy

on:
  push:
    tags:
      - 'backend/v*'
      - 'frontend/v*'

jobs:
  verify:
    runs-on: ubuntu-latest
    outputs:
      service: ${{ steps.detect.outputs.service }}
      version: ${{ steps.detect.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify prod branch
        run: |
          # Ensure we have the remote prod branch reference
          git fetch origin prod:refs/remotes/origin/prod --depth=1

          # Verify that the tag commit is reachable from origin/prod
          if ! git merge-base --is-ancestor "${{ github.sha }}" origin/prod; then
            echo "::error::Tag must be on prod branch"
            exit 1
          fi
      - name: Detect service
        id: detect
        run: |
          TAG="${{ github.ref_name }}"
          SERVICE="${TAG%%/v*}"
          VERSION="${TAG#*/}"
          echo "service=$SERVICE" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

  build:
    needs: verify
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build backend
        if: needs.verify.outputs.service == 'backend'
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.7'

      - name: Test backend
        if: needs.verify.outputs.service == 'backend'
        working-directory: backend
        run: |
          go build ./cmd/server
          go test ./...

      - name: Build frontend
        if: needs.verify.outputs.service == 'frontend'
        working-directory: frontend
        run: echo "Frontend build not configured yet"

      - name: Build Docker image
        run: docker compose build ${{ needs.verify.outputs.service }}

  deploy:
    needs: [verify, build]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::727014823495:role/hearoom-deployer-role
          aws-region: ap-northeast-2

      - name: Deploy via SSM
        uses: peterkimzz/aws-ssm-send-command@v1
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ env.AWS_SESSION_TOKEN }}
          aws-region: ap-northeast-2
          instance-ids: ${{ secrets.INSTANCE_ID }}
          command: |
            cd /hearoom
            git fetch --tags
            git checkout ${{ github.ref_name }}
            docker compose up --build -d ${{ needs.verify.outputs.service }}
