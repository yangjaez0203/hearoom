name: Deploy

on:
  push:
    tags:
      - 'backend/v*'
      - 'frontend/v*'

jobs:
  verify:
    runs-on: ubuntu-latest
    outputs:
      service: ${{ steps.detect.outputs.service }}
      version: ${{ steps.detect.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify prod branch
        run: |
          # Ensure we have the remote prod branch reference
          git fetch origin prod:refs/remotes/origin/prod --depth=1

          # Verify that the tag commit is reachable from origin/prod
          if ! git merge-base --is-ancestor "${{ github.sha }}" origin/prod; then
            echo "::error::Tag must be on prod branch"
            exit 1
          fi
      - name: Detect service
        id: detect
        run: |
          TAG="${{ github.ref_name }}"
          SERVICE="${TAG%%/v*}"
          VERSION="${TAG#*/}"
          echo "service=$SERVICE" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

  build:
    needs: verify
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build backend
        if: needs.verify.outputs.service == 'backend'
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.7'

      - name: Test backend
        if: needs.verify.outputs.service == 'backend'
        working-directory: backend
        run: |
          go build ./cmd/server
          go test ./...

      - name: Build frontend
        if: needs.verify.outputs.service == 'frontend'
        working-directory: frontend
        run: echo "Frontend build not configured yet"

      - name: Build Docker image
        run: docker compose build ${{ needs.verify.outputs.service }}

  deploy:
    needs: [verify, build]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::727014823495:role/hearoom-deployer-role
          aws-region: ap-northeast-2

      - name: Deploy via SSM
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["export HOME=/root && git config --global --add safe.directory /home/ubuntu/hearoom && cd /home/ubuntu/hearoom && git fetch --tags && git checkout ${{ github.ref_name }} && docker compose up --build -d ${{ needs.verify.outputs.service }}"]' \
            --region ap-northeast-2 \
            --query "Command.CommandId" \
            --output text)

          echo "Command ID: $COMMAND_ID"

          # 명령 완료 대기
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.INSTANCE_ID }}" \
            --region ap-northeast-2 || true

          # 결과 확인
          RESULT=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ secrets.INSTANCE_ID }}" \
            --region ap-northeast-2)

          STATUS=$(echo "$RESULT" | jq -r '.Status')
          echo "Status: $STATUS"
          echo "$RESULT" | jq -r '.StandardOutputContent'

          if [ "$STATUS" != "Success" ]; then
            echo "::error::SSM command failed"
            echo "$RESULT" | jq -r '.StandardErrorContent'
            exit 1
          fi
